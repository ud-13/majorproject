
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Tenant Verification</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .login-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        h1 {
            color: #1a73e8;
            margin-bottom: 2rem;
            text-align: center;
        }

        .role-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .role-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .role-btn.active {
            background: #1a73e8;
            color: white;
        }

        .role-btn:not(.active) {
            background: #e0e0e0;
            color: #333;
        }

        input[type="email"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .otp-container {
            margin: 1rem 0;
            text-align: center;
        }

        .otp-inputs {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin: 1rem 0;
        }

        .otp-input {
            width: 40px;
            height: 40px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1.2rem;
        }

        .action-btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 5px;
            background: #1a73e8;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .resend-text {
            text-align: center;
            margin-top: 1rem;
            color: #666;
        }

        .resend-link {
            color: #1a73e8;
            text-decoration: none;
            cursor: pointer;
        }

        .alert {
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .sign-up-link {
            display: block;
            text-align: center;
            margin-top: 1rem;
            text-decoration: none;
            color: #1a73e8;
        }
    </style>
</head>
<body>
    {% include 'header.html' %}

    <div class="login-container">
        <div class="login-box">
            <h1>Login</h1>
            
            <div id="alertBox" class="alert"></div>

            <div id="emailForm">
                <div class="role-selector">
                    <button class="role-btn" data-role="tenant">Tenant</button>
                    <button class="role-btn active" data-role="home_owner">Home Owner</button>
                    <button class="role-btn" data-role="police">Police</button>
                </div>

                <input type="email" id="email" placeholder="Enter your email" required>
                
                <button type="button" id="sendOtpBtn" class="action-btn">
                    <i class="fas fa-paper-plane"></i> Send OTP
                </button>
            </div>

            <div id="otpForm" style="display: none;">
                <div class="otp-container">
                    <p>Enter the 6-digit code sent to <span id="otpEmail"></span></p>
                    
                    <div class="otp-inputs">
                        <input type="text" maxlength="1" class="otp-input" pattern="[0-9]">
                        <input type="text" maxlength="1" class="otp-input" pattern="[0-9]">
                        <input type="text" maxlength="1" class="otp-input" pattern="[0-9]">
                        <input type="text" maxlength="1" class="otp-input" pattern="[0-9]">
                        <input type="text" maxlength="1" class="otp-input" pattern="[0-9]">
                        <input type="text" maxlength="1" class="otp-input" pattern="[0-9]">
                    </div>

                    <button type="button" id="verifyOtpBtn" class="action-btn">
                        <i class="fas fa-check-circle"></i> Verify OTP
                    </button>

                    <p class="resend-text">
                        Didn't receive code? <span id="resendOtp" class="resend-link">Resend OTP</span> (<span id="countdown">60</span>s)
                    </p>
                </div>
            </div>

            <a href="{% url 'signup_homeowner' %}" class="sign-up-link">Sign Up</a>
        </div>
    </div>

    {% include 'footer.html' %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const emailForm = document.getElementById('emailForm');
            const otpForm = document.getElementById('otpForm');
            const sendOtpBtn = document.getElementById('sendOtpBtn');
            const verifyOtpBtn = document.getElementById('verifyOtpBtn');
            const roleBtns = document.querySelectorAll('.role-btn');
            const otpInputs = document.querySelectorAll('.otp-input');
            const resendOtp = document.getElementById('resendOtp');
            const countdown = document.getElementById('countdown');
            const alertBox = document.getElementById('alertBox');
            
            let selectedRole = 'home_owner';
            let countdownInterval;
            let userEmail = '';

            // Role selection
            roleBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    roleBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedRole = btn.dataset.role;
                });
            });

            // OTP input handling
            otpInputs.forEach((input, index) => {
                input.addEventListener('input', () => {
                    if (input.value.length === 1) {
                        if (index < otpInputs.length - 1) {
                            otpInputs[index + 1].focus();
                        }
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !input.value && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });
            });

            // Show alert message
            function showAlert(message, type) {
                alertBox.textContent = message;
                alertBox.className = `alert ${type}`;
                alertBox.style.display = 'block';
                setTimeout(() => {
                    alertBox.style.display = 'none';
                }, 5000);
            }

            // Start countdown timer
            function startCountdown() {
                let timeLeft = 60;
                countdown.textContent = timeLeft;
                resendOtp.style.pointerEvents = 'none';
                
                clearInterval(countdownInterval);
                countdownInterval = setInterval(() => {
                    timeLeft--;
                    countdown.textContent = timeLeft;
                    
                    if (timeLeft <= 0) {
                        clearInterval(countdownInterval);
                        resendOtp.style.pointerEvents = 'auto';
                    }
                }, 1000);
            }

            // Send OTP button click handler
            sendOtpBtn.addEventListener('click', async () => {
                const email = document.getElementById('email').value.trim();
                
                if (!email) {
                    showAlert('Please enter your email address', 'error');
                    return;
                }

                userEmail = email;
                const formData = new FormData();
                formData.append('email', email);
                formData.append('role', selectedRole);

                try {
                    const response = await fetch('{% url "send_otp" %}', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        emailForm.style.display = 'none';
                        otpForm.style.display = 'block';
                        document.getElementById('otpEmail').textContent = email;
                        startCountdown();
                        showAlert('OTP sent successfully!', 'success');
                    } else {
                        showAlert(data.error || 'Failed to send OTP', 'error');
                    }
                } catch (error) {
                    showAlert('An error occurred. Please try again.', 'error');
                }
            });

            // Verify OTP button click handler
            verifyOtpBtn.addEventListener('click', async () => {
                const otp = Array.from(otpInputs).map(input => input.value).join('');
                
                if (otp.length !== 6) {
                    showAlert('Please enter the complete OTP', 'error');
                    return;
                }

                const formData = new FormData();
                formData.append('email', userEmail);
                formData.append('otp', otp);
                formData.append('role', selectedRole);

                try {
                    const response = await fetch('{% url "verify_otp" %}', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        showAlert('Verification successful! Redirecting...', 'success');
                        setTimeout(() => {
                            window.location.href = data.redirect_url;
                        }, 1500);
                    } else {
                        showAlert(data.error || 'Invalid OTP', 'error');
                        otpInputs.forEach(input => input.value = '');
                        otpInputs[0].focus();
                    }
                } catch (error) {
                    showAlert('An error occurred. Please try again.', 'error');
                }
            });

            // Resend OTP click handler
            resendOtp.addEventListener('click', () => {
                if (resendOtp.style.pointerEvents !== 'none') {
                    sendOtpBtn.click();
                }
            });
        });
    </script>
</body>
</html>
