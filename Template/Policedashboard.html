<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Police Dashboard - Tenant Verification System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container d-flex justify-content-between align-items-center">
            <h1>Police Verification Dashboard</h1>
            <div>
                <a href="/index/?role=police" class="btn btn-outline-light me-2">Home</a>
                <a href="/logout/" class="btn btn-outline-light">Logout</a>
            </div>
        </div>
    </header>

    <div class="container my-4">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card bg-primary text-white">
                    <div class="stat-card-body">
                        <div class="stat-icon">
                            <i data-feather="clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-title">Pending Verifications</h3>
                            <p class="stat-number">{{ tenants|length }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card bg-success text-white">
                    <div class="stat-card-body">
                        <div class="stat-icon">
                            <i data-feather="check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-title">Approved</h3>
                            <p class="stat-number">{{ approved_count|default:"0" }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card bg-danger text-white">
                    <div class="stat-card-body">
                        <div class="stat-icon">
                            <i data-feather="x-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-title">Rejected</h3>
                            <p class="stat-number">{{ rejected_count|default:"0" }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-{{ message.tags }}{% endif %} mb-4">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">Pending Tenant Verifications</h3>
            </div>
            <div class="card-body">
                {% if tenants %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>District</th>
                                    <th>Profession</th>
                                    <th>Date</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tenant in tenants %}
                                    <tr>
                                        <td>{{ tenant.first_name }} {{ tenant.last_name }}</td>
                                        <td>{{ tenant.tenant_phone_number }}</td>
                                        <td>{{ tenant.district }}</td>
                                        <td>{{ tenant.profession }}</td>
                                        <td>{{ tenant.created_at|date:"M d, Y" }}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-primary view-tenant-btn" data-id="{{ tenant.id }}" data-bs-toggle="modal" data-bs-target="#tenantModal">
                                                <i data-feather="eye" class="icon-sm"></i> View Details
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i data-feather="check-square"></i>
                        </div>
                        <h4>No Pending Verifications</h4>
                        <p class="text-muted">There are no tenant applications pending police verification at this time.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tenant Details Modal -->
    <div class="modal fade" id="tenantModal" tabindex="-1" aria-labelledby="tenantModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tenantModalLabel">Tenant Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="tenantDetails">
                        <!-- This will be populated dynamically -->
                        <div class="tenant-detail-section">
                            <h3>Personal Information</h3>
                            <div class="row">
                                <div class="col-md-4">
                                    <p><strong>Name:</strong> <span id="tenant-name"></span></p>
                                    <p><strong>Father's Name:</strong> <span id="tenant-father"></span></p>
                                    <p><strong>Phone:</strong> <span id="tenant-phone"></span></p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>Date of Birth:</strong> <span id="tenant-dob"></span></p>
                                    <p><strong>Age:</strong> <span id="tenant-age"></span></p>
                                    <p><strong>Profession:</strong> <span id="tenant-profession"></span></p>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div class="tenant-photo-container">
                                        <img id="tenant-photo" src="" alt="Tenant Photo" class="img-fluid">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tenant-detail-section">
                            <h3>Address Information</h3>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Permanent Address:</strong> <span id="tenant-address"></span></p>
                                    <p><strong>Village/Town:</strong> <span id="tenant-village"></span></p>
                                    <p><strong>Tehsil:</strong> <span id="tenant-tehsil"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>District:</strong> <span id="tenant-district"></span></p>
                                    <p><strong>Post Office:</strong> <span id="tenant-post-office"></span></p>
                                    <p><strong>Police Station:</strong> <span id="tenant-police-station"></span></p>
                                    <p><strong>PIN Code:</strong> <span id="tenant-pin-code"></span></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tenant-detail-section">
                            <h3>Family Members</h3>
                            <div id="family-members-container">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Age</th>
                                            <th>Relationship</th>
                                            <th>Profession</th>
                                        </tr>
                                    </thead>
                                    <tbody id="family-members-list">
                                        <!-- Will be populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="tenant-detail-section">
                            <h3>Previous Residences</h3>
                            <div id="previous-residences-container">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>From Place</th>
                                            <th>To Place</th>
                                            <th>Address</th>
                                        </tr>
                                    </thead>
                                    <tbody id="previous-residences-list">
                                        <!-- Will be populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="verification-action mt-4 pt-3 border-top">
                        <div class="row">
                            <div class="col-md-6">
                                <form action="" method="post" id="approveForm">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success w-100">
                                        <i data-feather="check-circle" class="icon-sm me-2"></i> Approve Verification
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-danger w-100" id="rejectBtn" data-bs-toggle="collapse" data-bs-target="#rejectForm">
                                    <i data-feather="x-circle" class="icon-sm me-2"></i> Reject Verification
                                </button>
                            </div>
                        </div>
                        
                        <div class="collapse mt-3" id="rejectForm">
                            <form action="" method="post" id="rejectFormElement">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="remark" class="form-label">Rejection Reason (required)</label>
                                    <textarea class="form-control" id="remark" name="remark" rows="3" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-danger">Submit Rejection</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/main.js"></script>
    <script>
        // Initialize Feather icons
        feather.replace();
        
        $(document).ready(function() {
            // Check verification status
            $.ajax({
                url: '/check-verification/',
                type: 'GET',
                success: function(response) {
                    if (!response.verified) {
                        window.location.href = '/';
                    }
                },
                error: function() {
                    window.location.href = '/';
                }
            });
            
            // View tenant details button
            $('.view-tenant-btn').click(function() {
                const tenantId = $(this).data('id');
                
                // Mock function to simulate tenant data
                // This would normally be replaced with a real AJAX call to get tenant details
                // In a real implementation, you'd fetch this data from the server using an API endpoint
                const tenants = [
                    {% for tenant in tenants %}
                    {
                        id: {{ tenant.id }},
                        firstName: "{{ tenant.first_name }}",
                        middleName: "{{ tenant.middle_name|default:'' }}",
                        lastName: "{{ tenant.last_name }}",
                        fatherName: "{{ tenant.father_name }}",
                        phone: "{{ tenant.tenant_phone_number }}",
                        dob: "{{ tenant.date_of_birth|date:'Y-m-d' }}",
                        age: {{ tenant.age|default:0 }},
                        profession: "{{ tenant.profession }}",
                        photo: "{{ tenant.photo.url }}",
                        address: "{{ tenant.permanent_address }}",
                        village: "{{ tenant.village }}",
                        tehsil: "{{ tenant.tehsil }}",
                        district: "{{ tenant.district }}",
                        postOffice: "{{ tenant.post_office }}",
                        policeStation: "{{ tenant.police_station }}",
                        pinCode: "{{ tenant.pin_code }}",
                        familyMembers: [
                            {% for fm in tenant.family_members.all %}
                            {
                                firstName: "{{ fm.first_name }}",
                                middleName: "{{ fm.middle_name|default:'' }}",
                                lastName: "{{ fm.last_name }}",
                                age: {{ fm.age|default:0 }},
                                relationship: "{{ fm.relationship }}",
                                profession: "{{ fm.profession }}"
                            }{% if not forloop.last %},{% endif %}
                            {% endfor %}
                        ],
                        previousResidences: [
                            {% for pr in tenant.Tenant_previousresidence.all %}
                            {
                                fromPlace: "{{ pr.from_place }}",
                                toPlace: "{{ pr.to_place }}",
                                address: "{{ pr.address }}"
                            }{% if not forloop.last %},{% endif %}
                            {% endfor %}
                        ]
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ];
                
                // Find the tenant with the matching ID
                const tenant = tenants.find(t => t.id === tenantId);
                
                if (tenant) {
                    // Update the modal with tenant details
                    $('#tenant-name').text(`${tenant.firstName} ${tenant.middleName ? tenant.middleName + ' ' : ''}${tenant.lastName}`);
                    $('#tenant-father').text(tenant.fatherName);
                    $('#tenant-phone').text(tenant.phone);
                    $('#tenant-dob').text(new Date(tenant.dob).toLocaleDateString('en-US', { 
                        day: 'numeric', month: 'long', year: 'numeric' 
                    }));
                    $('#tenant-age').text(tenant.age);
                    $('#tenant-profession').text(tenant.profession);
                    $('#tenant-address').text(tenant.address);
                    $('#tenant-village').text(tenant.village);
                    $('#tenant-tehsil').text(tenant.tehsil);
                    $('#tenant-district').text(tenant.district);
                    $('#tenant-post-office').text(tenant.postOffice);
                    $('#tenant-police-station').text(tenant.policeStation);
                    $('#tenant-pin-code').text(tenant.pinCode);
                    
                    // Set tenant photo
                    if (tenant.photo) {
                        $('#tenant-photo').attr('src', tenant.photo).show();
                    } else {
                        $('#tenant-photo').hide();
                    }
                    
                    // Clear and populate family members
                    const familyMembersList = $('#family-members-list');
                    familyMembersList.empty();
                    
                    if (tenant.familyMembers && tenant.familyMembers.length > 0) {
                        tenant.familyMembers.forEach(member => {
                            const name = `${member.firstName} ${member.middleName ? member.middleName + ' ' : ''}${member.lastName}`;
                            familyMembersList.append(`
                                <tr>
                                    <td>${name}</td>
                                    <td>${member.age}</td>
                                    <td>${member.relationship}</td>
                                    <td>${member.profession}</td>
                                </tr>
                            `);
                        });
                    } else {
                        familyMembersList.append('<tr><td colspan="4" class="text-center">No family members listed</td></tr>');
                    }
                    
                    // Clear and populate previous residences
                    const previousResidencesList = $('#previous-residences-list');
                    previousResidencesList.empty();
                    
                    if (tenant.previousResidences && tenant.previousResidences.length > 0) {
                        tenant.previousResidences.forEach(residence => {
                            previousResidencesList.append(`
                                <tr>
                                    <td>${residence.fromPlace}</td>
                                    <td>${residence.toPlace}</td>
                                    <td>${residence.address}</td>
                                </tr>
                            `);
                        });
                    } else {
                        previousResidencesList.append('<tr><td colspan="3" class="text-center">No previous residences listed</td></tr>');
                    }
                    
                    // Set form action URLs
                    $('#approveForm').attr('action', `/police/approve/${tenantId}/`);
                    $('#rejectFormElement').attr('action', `/police/reject/${tenantId}/`);
                }
            });
        });
    </script>
</body>
</html>
